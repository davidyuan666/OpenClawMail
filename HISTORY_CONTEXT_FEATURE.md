# 历史上下文功能说明

## 功能概述

历史上下文功能允许在执行任务时自动加载最近完成的任务历史记录，使 AI 能够了解之前的工作内容，实现任务之间的连续性和上下文感知。

**重要说明**：历史上下文是从任务中提取关键信息后压缩存储的，与原始任务记录分离。清除历史上下文不会影响任务记录本身。

## 主要特性

### 1. 可配置的历史上下文加载
- **开关控制**: 在左侧边栏底部新增"历史上下文"面板，支持一键开启/关闭
- **历史记录数量**: 默认保留最近 5 条上下文记录，可配置
- **智能集成**: 启用后，每次执行任务时会自动在提示词中包含历史上下文
- **自动压缩**: 任务完成后自动提取关键信息并压缩存储

### 2. 历史记录统计
实时显示：
- 上下文记录数：当前保存的历史上下文数量
- 最大保留数：配置的最大保留记录数

### 3. 历史记录管理
- **自动管理**: 超过最大保留数时，自动删除最旧的记录
- **清除历史**: 一键清除所有历史上下文记录（不影响任务记录）
- **自动更新**: 统计数据每 10 秒自动刷新

## 使用方法

### 启用历史上下文

1. 打开 OpenClawMail Web 界面
2. 在左侧边栏底部找到"历史上下文"面板
3. 点击"历史载入"开关启用功能
4. 启用后，所有新执行的任务都会自动包含历史上下文信息

### 查看历史统计

在"历史上下文"面板中可以看到：
- 上下文记录：当前保存的压缩历史记录数量
- 最大保留：配置的最大保留记录数（默认 5）

### 清除历史记录

1. 点击"🗑️ 清除历史"按钮
2. 确认操作
3. 系统会删除所有历史上下文记录
4. **注意**：这不会删除任务记录本身，只删除压缩的上下文记录

## 技术实现

### 后端组件

1. **history_manager.py**: 历史上下文管理模块
   - 管理历史配置（启用/禁用、记录数量）
   - 自动压缩任务信息并存储
   - 获取最近的历史上下文
   - 构建历史上下文字符串
   - 清除历史上下文记录

2. **数据库表**:
   - `history_config`: 存储配置
     - `enabled`: 是否启用历史上下文（0/1）
     - `max_history_count`: 最大历史记录数（默认 5）
     - `updated_at`: 最后更新时间

   - `history_context_records`: 存储压缩的历史上下文
     - `id`: 自增主键
     - `task_id`: 关联的任务ID
     - `summary`: 压缩后的任务摘要（任务内容前200字 + 结果前300字）
     - `created_at`: 创建时间

3. **API 端点**:
   - `GET /api/history/config`: 获取历史配置
   - `POST /api/history/config`: 更新历史配置
   - `GET /api/history/stats`: 获取历史统计
   - `GET /api/history/records`: 获取历史记录列表
   - `POST /api/history/clear`: 清除历史上下文记录

### 前端组件

1. **UI 面板**: 在左侧边栏底部添加历史上下文控制面板
2. **JavaScript 函数**:
   - `loadHistoryContextStatus()`: 加载历史状态
   - `toggleHistoryContext()`: 切换历史开关
   - `clearHistoryRecords()`: 清除历史上下文记录

### 集成方式

1. **任务完成时自动保存**：
   - 在 `claude_executor.py` 的 `execute_task()` 方法中
   - 任务成功完成后，自动调用 `history_manager.add_context_record()`
   - 提取任务内容（前200字）和结果（前300字）进行压缩存储

2. **任务执行时自动加载**：
   - 在 `claude_executor.py` 的 `_build_context_prompt()` 方法中
   - 检查历史上下文是否启用
   - 如果启用，自动获取最近的历史记录
   - 将历史信息格式化后添加到任务提示词中

## 历史上下文格式

当启用历史上下文时，每个任务的提示词会包含类似以下格式的历史信息：

```
## 历史任务上下文

以下是最近完成的任务记录，可以帮助你了解之前的工作内容：

### 历史任务 1
- **任务ID**: task_20260214_123456_789012
- **时间**: 2026-02-14T12:34:56
任务: 分析 SCI 论文数据...
结果: 成功分析了 10 篇论文...

### 历史任务 2
...
```

## 配置选项

可以通过 API 修改配置：

```bash
# 启用历史上下文
curl -X POST http://localhost:5000/api/history/config \
  -H "Content-Type: application/json" \
  -d '{"enabled": true}'

# 设置最大历史记录数
curl -X POST http://localhost:5000/api/history/config \
  -H "Content-Type: application/json" \
  -d '{"max_history_count": 10}'
```

## 数据流程

1. **任务执行** → 任务完成 → 自动提取关键信息
2. **压缩存储** → 保存到 `history_context_records` 表
3. **自动清理** → 超过最大数量时删除最旧记录
4. **上下文加载** → 新任务执行时自动包含历史上下文
5. **手动清除** → 用户可随时清除所有历史上下文

## 注意事项

1. **任务记录不受影响**: 清除历史上下文不会删除或归档任务记录
2. **自动压缩**: 只保存任务内容前200字和结果前300字，节省存储空间
3. **性能影响**: 历史上下文会增加提示词长度，可能略微增加 API 调用成本
4. **隐私考虑**: 历史记录包含之前任务的内容和结果，请注意敏感信息
5. **存储管理**: 超过最大数量时自动删除最旧记录，无需手动管理
6. **上下文限制**: 默认只加载最近 5 条记录，避免超出 token 限制

## 使用场景

### 适合启用历史上下文的场景：
- 连续的数据分析任务
- 多步骤的项目开发
- 需要参考之前结果的任务
- 迭代优化类任务

### 不需要历史上下文的场景：
- 独立的一次性任务
- 不相关的任务序列
- 对隐私要求较高的任务
- 需要最小化 token 使用的场景

## 更新日志

### v2.0.0 (2026-02-14)
- 🔄 重新设计：历史上下文与任务记录分离
- ✨ 自动压缩：只保存关键信息（任务前200字+结果前300字）
- ✨ 独立存储：使用专门的 `history_context_records` 表
- ✨ 自动管理：超过最大数量时自动删除最旧记录
- 🐛 修复：清除历史不再影响任务记录

### v1.0.0 (2026-02-14)
- ✨ 新增历史上下文功能
- ✨ 支持开关控制
- ✨ 支持历史记录统计
- ✨ 支持清除历史记录
- ✨ 自动集成到任务执行流程
