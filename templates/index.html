<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClawMail - ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #f1f3f4;
            min-height: 100vh;
            color: #202124;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  - Gmail é£æ ¼ */
        .top-nav {
            background: #fff;
            border-bottom: 1px solid #dadce0;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            position: relative;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 400;
            color: #5f6368;
            letter-spacing: -0.5px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4285f4 0%, #1967d2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3);
        }

        .search-box {
            flex: 1;
            max-width: 720px;
            margin: 0 40px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background: #f1f3f4;
            transition: all 0.2s;
            color: #202124;
        }

        .search-input:focus {
            outline: none;
            background: #fff;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
        }

        .search-input::placeholder {
            color: #5f6368;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: #5f6368;
        }

        /* ä¸»å®¹å™¨ - Gmail å¸ƒå±€ */
        .main-container {
            display: flex;
            height: calc(100vh - 64px);
            background: #f1f3f4;
        }

        /* å·¦ä¾§è¾¹æ  - Gmail é£æ ¼ */
        .sidebar {
            width: 260px;
            background: transparent;
            padding: 8px 8px 0 8px;
            overflow-y: auto;
        }

        .compose-btn {
            width: 100%;
            padding: 0 20px;
            height: 56px;
            background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
            color: #fff;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            box-shadow: 0 2px 4px 0 rgba(26,115,232,0.3), 0 2px 6px 2px rgba(26,115,232,0.15);
            transition: all 0.2s;
            margin-bottom: 16px;
            margin-left: 0;
            position: relative;
            overflow: visible;
        }

        .compose-btn:hover {
            box-shadow: 0 3px 6px 0 rgba(26,115,232,0.4), 0 4px 10px 3px rgba(26,115,232,0.2);
            transform: translateY(-1px);
            background: linear-gradient(135deg, #1765cc 0%, #1557b0 100%);
        }

        .compose-btn:active {
            box-shadow: 0 1px 3px 0 rgba(26,115,232,0.3);
            transform: translateY(0);
        }

        .compose-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            font-size: 16px;
        }

        .nav-item {
            padding: 0 12px 0 20px;
            height: 40px;
            margin: 2px 0;
            border-radius: 0 20px 20px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: #202124;
            transition: all 0.15s;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(32,33,36,0.059);
        }

        .nav-item.active {
            background: #d3e3fd;
            color: #001d35;
            font-weight: 700;
        }

        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 20px;
            opacity: 0.87;
        }

        .nav-count {
            margin-left: auto;
            background: transparent;
            color: #5f6368;
            padding: 0;
            border-radius: 0;
            font-size: 13px;
            font-weight: 500;
        }

        .nav-item.active .nav-count {
            background: transparent;
            color: #001d35;
            font-weight: 700;
        }

        /* ä¸­é—´ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ - Gmail é£æ ¼ */
        .task-list-panel {
            width: 400px;
            background: #fff;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .panel-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #dadce0;
            background: #fff;
        }

        .panel-title {
            font-size: 22px;
            font-weight: 400;
            color: #202124;
            margin-bottom: 4px;
            letter-spacing: 0;
        }

        .panel-subtitle {
            font-size: 13px;
            color: #5f6368;
            font-weight: 400;
        }

        .task-items {
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }

        .task-item {
            padding: 12px 24px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            background: #fff;
        }

        .task-item:hover {
            box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0, 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            z-index: 1;
        }

        .task-item.selected {
            background: #fef7e0;
            border-left: none;
            box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0;
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .task-id-badge {
            font-family: 'Roboto Mono', 'Courier New', monospace;
            font-size: 11px;
            background: #f5f7fa;
            padding: 3px 8px;
            border-radius: 4px;
            color: #5f6368;
        }

        .task-time {
            font-size: 12px;
            color: #5f6368;
        }

        .task-preview {
            font-size: 14px;
            color: #2c3e50;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .task-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
            letter-spacing: 0.3px;
        }

        .status-inbox { background: #e8f0fe; color: #1967d2; }
        .status-processing { background: #fef7e0; color: #ea8600; }
        .status-completed { background: #e6f4ea; color: #137333; }
        .status-failed { background: #fce8e6; color: #c5221f; }

        /* å³ä¾§è¯¦æƒ…é¢æ¿ - Gmail é£æ ¼ */
        .detail-panel {
            flex: 1;
            background: #fff;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .detail-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #5f6368;
        }

        .detail-empty-icon {
            font-size: 72px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .detail-empty p {
            font-size: 14px;
            color: #5f6368;
        }

        .detail-content {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .detail-content.show {
            display: flex;
        }

        .detail-header {
            padding: 24px 32px;
            border-bottom: 1px solid #dadce0;
            background: #fff;
        }

        .detail-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 8px 24px;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
            color: #1967d2;
        }

        .action-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .action-btn:active {
            background: #f1f3f4;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3);
        }

        .action-btn.primary {
            background: #1a73e8;
            color: #fff;
            border-color: #1a73e8;
        }

        .action-btn.primary:hover {
            background: #1765cc;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .action-btn.primary:active {
            background: #1557b0;
        }

        .action-btn.danger {
            color: #d93025;
            border-color: #dadce0;
        }

        .action-btn.danger:hover {
            background: #fce8e6;
            border-color: #d93025;
        }

        .action-btn.primary:hover {
            background: #1557b0;
        }

        .action-btn.danger {
            color: #d32f2f;
        }

        .action-btn.danger:hover {
            background: #ffebee;
            border-color: #d32f2f;
        }

        .detail-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .meta-item {
            font-size: 13px;
        }

        .meta-label {
            color: #5f6368;
            margin-bottom: 4px;
        }

        .meta-value {
            color: #2c3e50;
            font-weight: 500;
        }

        .detail-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #5f6368;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-box {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        .result-box {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        .error-box {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
            color: #c62828;
        }

        /* ä»»åŠ¡å†…åµŒè¿›åº¦åŒºåŸŸ */
        .task-progress-section {
            margin-bottom: 24px;
        }

        .progress-box {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-output {
            padding: 16px;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }

        .progress-info {
            padding: 12px 16px;
            background: #2d2d2d;
            border-top: 1px solid #333;
            font-size: 12px;
            color: #9e9e9e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* å®æ—¶è¿›åº¦é¢æ¿ */
        .progress-panel {
            display: none;
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 500px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 999;
        }

        .progress-panel.show {
            display: flex;
            flex-direction: column;
        }

        .progress-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-title {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .progress-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .progress-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .progress-line {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .progress-footer {
            padding: 12px 20px;
            background: #f5f7fa;
            border-top: 1px solid #e1e8ed;
            font-size: 12px;
            color: #5f6368;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* æ¨¡æ€æ¡† - Material Design é£æ ¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.show { display: flex; }

        .modal-content {
            background: #fff;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 8px 10px 1px rgba(0,0,0,0.14), 0 3px 14px 2px rgba(0,0,0,0.12), 0 5px 5px -3px rgba(0,0,0,0.2);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 24px 24px 20px;
            border-bottom: 1px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 400;
            color: #202124;
            letter-spacing: 0;
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #5f6368;
            line-height: 1;
            padding: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.15s;
            font-size: 24px;
        }

        .close-btn:hover {
            background: #f1f3f4;
            color: #202124;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 180px);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #5f6368;
            margin-bottom: 8px;
            letter-spacing: 0.2px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.15s;
            color: #202124;
            background: #fff;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 160px;
            line-height: 1.6;
            font-size: 14px;
        }

        .form-hint {
            font-size: 12px;
            color: #5f6368;
            margin-top: 6px;
            line-height: 1.4;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #dadce0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: #fff;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            letter-spacing: 0.25px;
        }

        .btn-secondary {
            background: transparent;
            color: #1a73e8;
            border: 1px solid transparent;
        }

        .btn-secondary:hover {
            background: #f1f3f4;
        }

        .btn-secondary:active {
            background: #e8eaed;
        }

        .btn-primary {
            background: #1a73e8;
            color: #fff;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .btn-primary:hover {
            background: #1765cc;
            box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
        }

        .btn-primary:active {
            background: #1557b0;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3);
        }
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #9e9e9e;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f5f7fa;
            color: #2c3e50;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #f5f7fa;
            color: #5f6368;
        }

        .btn-secondary:hover {
            background: #e1e8ed;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        /* å¼€å…³æŒ‰é’®æ ·å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #4caf50;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .task-list-panel {
                width: 320px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .task-list-panel {
                width: 100%;
                border-right: none;
            }

            .detail-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-nav">
        <div class="logo">
            <div class="logo-icon">ğŸ“§</div>
            <span>OpenClawMail</span>
        </div>
        <div class="search-box">
            <input type="text" class="search-input" placeholder="æœç´¢ä»»åŠ¡..." id="searchInput">
        </div>
        <div class="user-info">
            <span id="currentTime">--:--</span>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <button class="compose-btn" onclick="openComposeModal()">
                <span class="compose-icon">âœ¨</span>
                <span>æ–°å»ºä»»åŠ¡</span>
            </button>

            <div class="nav-item active" data-filter="all" onclick="filterTasks('all', this)">
                <span class="nav-icon">ğŸ“¬</span>
                <span>å…¨éƒ¨ä»»åŠ¡</span>
                <span class="nav-count" id="count-all">0</span>
            </div>

            <div class="nav-item" data-filter="å¾…å¤„ç†" onclick="filterTasks('å¾…å¤„ç†', this)">
                <span class="nav-icon">ğŸ“¥</span>
                <span>å¾…å¤„ç†</span>
                <span class="nav-count" id="count-å¾…å¤„ç†">0</span>
            </div>

            <div class="nav-item" data-filter="å¤„ç†ä¸­" onclick="filterTasks('å¤„ç†ä¸­', this)">
                <span class="nav-icon">âš™ï¸</span>
                <span>å¤„ç†ä¸­</span>
                <span class="nav-count" id="count-å¤„ç†ä¸­">0</span>
            </div>

            <div class="nav-item" data-filter="å·²å®Œæˆ" onclick="filterTasks('å·²å®Œæˆ', this)">
                <span class="nav-icon">âœ…</span>
                <span>å·²å®Œæˆ</span>
                <span class="nav-count" id="count-å·²å®Œæˆ">0</span>
            </div>

            <div class="nav-item" data-filter="å¤±è´¥" onclick="filterTasks('å¤±è´¥', this)">
                <span class="nav-icon">âŒ</span>
                <span>å¤±è´¥</span>
                <span class="nav-count" id="count-å¤±è´¥">0</span>
            </div>

            <div class="nav-item" data-filter="å·²å½’æ¡£" onclick="filterTasks('å·²å½’æ¡£', this)">
                <span class="nav-icon">ğŸ“¦</span>
                <span>å·²å½’æ¡£</span>
                <span class="nav-count" id="count-å·²å½’æ¡£">0</span>
            </div>

            <!-- è‡ªåŠ¨å·¡èˆªæ§åˆ¶é¢æ¿ -->
            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #dadce0;">
                <div style="padding: 0 20px 8px; font-size: 11px; font-weight: 500; color: #5f6368; text-transform: uppercase; letter-spacing: 0.8px;">
                    è‡ªåŠ¨å·¡èˆª
                </div>

                <div style="padding: 16px; background: #fff; border-radius: 8px; margin: 0 8px; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">ğŸš€</span>
                            <span style="font-size: 14px; font-weight: 500; color: #202124;">è‡ªåŠ¨æ‰§è¡Œ</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoExecutorToggle" onchange="toggleAutoExecutor()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div id="autoExecutorStatus" style="font-size: 13px; color: #5f6368; line-height: 1.8;">
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>å¾…å¤„ç†</span>
                            <span id="autoPendingCount" style="font-weight: 500; color: #202124;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>é˜Ÿåˆ—ä¸­</span>
                            <span id="autoQueueSize" style="font-weight: 500; color: #ea8600;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>æ‰§è¡Œä¸­</span>
                            <span id="autoProcessingCount" style="font-weight: 500; color: #137333;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>å·¥ä½œçº¿ç¨‹</span>
                            <span id="autoWorkerCount" style="font-weight: 500; color: #202124;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0 4px; margin-top: 8px; border-top: 1px solid #f1f3f4;">
                            <span style="font-weight: 500;">ä¸‹æ¬¡æ£€æŸ¥</span>
                            <span id="autoCountdown" style="font-weight: 600; color: #1a73e8;">-</span>
                        </div>
                    </div>

                    <button onclick="openAutoExecutorSettings()" style="width: 100%; margin-top: 16px; padding: 10px; background: #fff; border: 1px solid #dadce0; border-radius: 20px; font-size: 13px; font-weight: 500; color: #1a73e8; cursor: pointer; transition: all 0.15s;">
                        âš™ï¸ è®¾ç½®
                    </button>
                </div>
            </div>

            <!-- MCP ç®¡ç†é¢æ¿ -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dadce0;">
                <div style="padding: 0 20px 8px; font-size: 11px; font-weight: 500; color: #5f6368; text-transform: uppercase; letter-spacing: 0.8px;">
                    MCP å·¥å…·
                </div>

                <div style="padding: 16px; background: #fff; border-radius: 8px; margin: 0 8px; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 20px;">ğŸ”§</span>
                        <span style="font-size: 14px; font-weight: 500; color: #202124;">å·¥å…·ç®¡ç†</span>
                    </div>

                    <div style="font-size: 13px; color: #5f6368; margin-bottom: 12px;">
                        å·²é…ç½® <span id="mcpCount" style="font-weight: 600; color: #1a73e8;">0</span> ä¸ªå·¥å…·
                    </div>

                    <button onclick="openMCPManager()" style="width: 100%; padding: 10px; background: #fff; border: 1px solid #dadce0; border-radius: 20px; font-size: 13px; font-weight: 500; color: #1a73e8; cursor: pointer; transition: all 0.15s;">
                        ğŸ”§ ç®¡ç† MCP
                    </button>
                </div>
            </div>

            <!-- CC Switch ç®¡ç†é¢æ¿ -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dadce0;">
                <div style="padding: 0 20px 8px; font-size: 11px; font-weight: 500; color: #5f6368; text-transform: uppercase; letter-spacing: 0.8px;">
                    CC SWITCH
                </div>

                <div style="padding: 16px; background: #fff; border-radius: 8px; margin: 0 8px; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 20px;">ğŸ”„</span>
                        <span style="font-size: 14px; font-weight: 500; color: #202124;">é…ç½®åˆ‡æ¢</span>
                    </div>

                    <div id="ccSwitchCurrentStatus" style="font-size: 13px; color: #5f6368; margin-bottom: 12px;">
                        å½“å‰: <span id="ccSwitchCurrent" style="font-weight: 600; color: #137333;">æœªè®¾ç½®</span>
                    </div>

                    <div style="font-size: 13px; color: #5f6368; margin-bottom: 12px;">
                        å·²é…ç½® <span id="ccSwitchCount" style="font-weight: 600; color: #1a73e8;">0</span> ä¸ªç«¯ç‚¹
                    </div>

                    <button onclick="openCCSwitchManager()" style="width: 100%; padding: 10px; background: #fff; border: 1px solid #dadce0; border-radius: 20px; font-size: 13px; font-weight: 500; color: #1a73e8; cursor: pointer; transition: all 0.15s;">
                        ğŸ”„ ç®¡ç†é…ç½®
                    </button>
                </div>
            </div>

            <!-- å†å²ä¸Šä¸‹æ–‡ç®¡ç†é¢æ¿ -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dadce0;">
                <div style="padding: 0 20px 8px; font-size: 11px; font-weight: 500; color: #5f6368; text-transform: uppercase; letter-spacing: 0.8px;">
                    å†å²ä¸Šä¸‹æ–‡
                </div>

                <div style="padding: 16px; background: #fff; border-radius: 8px; margin: 0 8px; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">ğŸ“š</span>
                            <span style="font-size: 14px; font-weight: 500; color: #202124;">å†å²è½½å…¥</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="historyContextToggle" onchange="toggleHistoryContext()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div id="historyContextStatus" style="font-size: 13px; color: #5f6368; line-height: 1.8;">
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>ä¸Šä¸‹æ–‡è®°å½•</span>
                            <span id="historyTotalCount" style="font-weight: 500; color: #202124;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                            <span>æœ€å¤§ä¿ç•™</span>
                            <span id="historyMaxCount" style="font-weight: 500; color: #1a73e8;">-</span>
                        </div>
                    </div>

                    <button onclick="clearHistoryRecords()" style="width: 100%; margin-top: 16px; padding: 10px; background: #fff; border: 1px solid #dadce0; border-radius: 20px; font-size: 13px; font-weight: 500; color: #d93025; cursor: pointer; transition: all 0.15s;">
                        ğŸ—‘ï¸ æ¸…é™¤å†å²
                    </button>
                </div>
            </div>

            <!-- Email é…ç½®é¢æ¿ -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dadce0;">
                <div style="padding: 0 20px 8px; font-size: 11px; font-weight: 500; color: #5f6368; text-transform: uppercase; letter-spacing: 0.8px;">
                    EMAIL é€šçŸ¥
                </div>

                <div style="padding: 16px; background: #fff; border-radius: 8px; margin: 0 8px; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">ğŸ“§</span>
                            <span style="font-size: 14px; font-weight: 500; color: #202124;">é‚®ä»¶é€šçŸ¥</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="emailToggle" onchange="toggleEmail()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div style="font-size: 13px; color: #5f6368; margin-bottom: 12px;">
                        æ¥æ”¶é‚®ç®±: <span id="emailAddress" style="font-weight: 500; color: #202124;">-</span>
                    </div>

                    <button onclick="openEmailSettings()" style="width: 100%; padding: 10px; background: #fff; border: 1px solid #dadce0; border-radius: 20px; font-size: 13px; font-weight: 500; color: #1a73e8; cursor: pointer; transition: all 0.15s;">
                        âš™ï¸ é…ç½®
                    </button>
                </div>
            </div>

            <!-- Telegram é…ç½®é¢æ¿ -->
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #dadce0;">
                <div style="padding: 0 20px 8px; font-size: 11px; font-weight: 500; color: #5f6368; text-transform: uppercase; letter-spacing: 0.8px;">
                    TELEGRAM é€šçŸ¥
                </div>

                <div style="padding: 16px; background: #fff; border-radius: 8px; margin: 0 8px; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">âœˆï¸</span>
                            <span style="font-size: 14px; font-weight: 500; color: #202124;">Telegram</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="telegramToggle" onchange="toggleTelegram()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div style="font-size: 13px; color: #5f6368; margin-bottom: 12px;">
                        Chat ID: <span id="telegramChatId" style="font-weight: 500; color: #202124;">-</span>
                    </div>

                    <button onclick="openTelegramSettings()" style="width: 100%; padding: 10px; background: #fff; border: 1px solid #dadce0; border-radius: 20px; font-size: 13px; font-weight: 500; color: #1a73e8; cursor: pointer; transition: all 0.15s;">
                        âš™ï¸ é…ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´ä»»åŠ¡åˆ—è¡¨é¢æ¿ -->
        <div class="task-list-panel">
            <div class="panel-header">
                <div class="panel-title" id="panelTitle">å…¨éƒ¨ä»»åŠ¡</div>
                <div class="panel-subtitle" id="panelSubtitle">åŠ è½½ä¸­...</div>
            </div>
            <div class="task-items" id="taskItems">
                <!-- ä»»åŠ¡åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- å³ä¾§è¯¦æƒ…é¢æ¿ -->
        <div class="detail-panel">
            <div class="detail-empty" id="detailEmpty">
                <div class="detail-empty-icon">ğŸ“­</div>
                <p>é€‰æ‹©ä¸€ä¸ªä»»åŠ¡æŸ¥çœ‹è¯¦æƒ…</p>
            </div>

            <div class="detail-content" id="detailContent">
                <!-- ä»»åŠ¡è¯¦æƒ…å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- æ–°å»ºä»»åŠ¡æ¨¡æ€æ¡† -->
    <div class="modal" id="composeModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">æ–°å»ºä»»åŠ¡</h2>
                <button class="close-btn" onclick="closeComposeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡å†…å®¹</label>
                    <textarea class="form-textarea" id="taskMessage" placeholder="æè¿°æ‚¨å¸Œæœ› Claude å®Œæˆçš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ åˆ†æè¿™ä»½æ•°æ®æŠ¥å‘Šå¹¶ç”Ÿæˆæ‘˜è¦&#10;â€¢ ç¼–å†™ä¸€ä¸ª Python è„šæœ¬å¤„ç† CSV æ–‡ä»¶&#10;â€¢ å¸®æˆ‘ä¼˜åŒ–è¿™æ®µä»£ç çš„æ€§èƒ½"></textarea>
                    <div class="form-hint">ğŸ’¡ æç¤ºï¼šæè¿°è¶Šè¯¦ç»†ï¼ŒClaude æ‰§è¡Œæ•ˆæœè¶Šå¥½</div>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼˜å…ˆçº§</label>
                    <select class="form-select" id="taskPriority">
                        <option value="normal">æ™®é€š - æŒ‰é¡ºåºæ‰§è¡Œ</option>
                        <option value="high">é«˜ä¼˜å…ˆçº§ - ä¼˜å…ˆæ‰§è¡Œ</option>
                        <option value="urgent">ç´§æ€¥ - ç«‹å³æ‰§è¡Œ</option>
                    </select>
                    <div class="form-hint">è‡ªåŠ¨å·¡èˆªåŠŸèƒ½ä¼šæŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œä»»åŠ¡</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeComposeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createTask()">åˆ›å»ºä»»åŠ¡</button>
            </div>
        </div>
    </div>

    <!-- è‡ªåŠ¨å·¡èˆªè®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="autoExecutorSettingsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸš€ è‡ªåŠ¨å·¡èˆªè®¾ç½®</h2>
                <button class="close-btn" onclick="closeAutoExecutorSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" class="form-input" id="settingInterval" min="10" max="3600" placeholder="60">
                    <div style="font-size: 12px; color: #5f6368; margin-top: 4px;">
                        ç³»ç»Ÿæ¯éš”æŒ‡å®šæ—¶é—´æ£€æŸ¥ä¸€æ¬¡å¾…å¤„ç†ä»»åŠ¡ï¼ˆå»ºè®® 30-300 ç§’ï¼‰
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°</label>
                    <input type="number" class="form-input" id="settingMaxConcurrent" min="1" max="10" placeholder="1">
                    <div style="font-size: 12px; color: #5f6368; margin-top: 4px;">
                        åŒæ—¶æ‰§è¡Œçš„æœ€å¤§ä»»åŠ¡æ•°é‡ï¼ˆå»ºè®® 1-3 ä¸ªï¼Œæ ¹æ®ç³»ç»Ÿæ€§èƒ½è°ƒæ•´ï¼‰
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼˜å…ˆçº§é¡ºåº</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="padding: 6px 12px; background: #ffebee; color: #c62828; border-radius: 4px; font-size: 12px; font-weight: 500;">é«˜ä¼˜å…ˆçº§</span>
                        <span style="color: #9e9e9e;">â†’</span>
                        <span style="padding: 6px 12px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-size: 12px; font-weight: 500;">æ™®é€š</span>
                        <span style="color: #9e9e9e;">â†’</span>
                        <span style="padding: 6px 12px; background: #f5f5f5; color: #616161; border-radius: 4px; font-size: 12px; font-weight: 500;">ä½ä¼˜å…ˆçº§</span>
                    </div>
                    <div style="font-size: 12px; color: #5f6368; margin-top: 8px;">
                        ä»»åŠ¡å°†æŒ‰ç…§æ­¤é¡ºåºè‡ªåŠ¨æ‰§è¡Œ
                    </div>
                </div>
                <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 12px; border-radius: 4px; margin-top: 16px;">
                    <div style="font-size: 13px; color: #2e7d32; font-weight: 500; margin-bottom: 4px;">ğŸ’¡ ä½¿ç”¨å»ºè®®</div>
                    <ul style="font-size: 12px; color: #388e3c; margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li>å•æ ¸æˆ–èµ„æºæœ‰é™ï¼šå¹¶å‘æ•°è®¾ä¸º 1</li>
                        <li>å¤šæ ¸ CPUï¼šå¹¶å‘æ•°å¯è®¾ä¸º 2-3</li>
                        <li>ä»»åŠ¡è¾ƒå¤šæ—¶ï¼šç¼©çŸ­æ£€æŸ¥é—´éš”</li>
                        <li>ä»»åŠ¡è¾ƒå°‘æ—¶ï¼šå»¶é•¿æ£€æŸ¥é—´éš”èŠ‚çœèµ„æº</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAutoExecutorSettings()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveAutoExecutorSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- MCP ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="mcpManagerModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ”§ MCP å·¥å…·ç®¡ç†</h2>
                <button class="close-btn" onclick="closeMCPManager()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #5f6368;">
                        ç®¡ç† Claude Code CLI å¯ç”¨çš„ MCP å·¥å…·
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="scanLocalMCPs()" style="padding: 8px 16px; font-size: 13px;">
                            ğŸ” æ‰«ææœ¬åœ°
                        </button>
                        <button class="btn btn-primary" onclick="openAddMCPModal()" style="padding: 8px 16px; font-size: 13px;">
                            â• æ·»åŠ  MCP
                        </button>
                    </div>
                </div>

                <div id="mcpList" style="max-height: 500px; overflow-y: auto;">
                    <!-- MCP åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMCPManager()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ MCP æ¨¡æ€æ¡† -->
    <div class="modal" id="addMCPModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="addMCPModalTitle">â• æ·»åŠ  MCP</h2>
                <button class="close-btn" onclick="closeAddMCPModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">MCP åç§°</label>
                    <input type="text" class="form-input" id="mcpName" placeholder="ä¾‹å¦‚: telegram-mcp">
                    <div class="form-hint">ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦ï¼Œä¾‹å¦‚: arxiv-search</div>
                </div>
                <div class="form-group">
                    <label class="form-label">å‘½ä»¤</label>
                    <input type="text" class="form-input" id="mcpCommand" placeholder="python" value="python">
                    <div class="form-hint">é€šå¸¸ä¸º python æˆ– node</div>
                </div>
                <div class="form-group">
                    <label class="form-label">è„šæœ¬è·¯å¾„</label>
                    <input type="text" class="form-input" id="mcpArgs" placeholder="C:/path/to/server.py">
                    <div class="form-hint">MCP æœåŠ¡å™¨è„šæœ¬çš„å®Œæ•´è·¯å¾„</div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea class="form-textarea" id="mcpEnv" placeholder='{"KEY": "value"}' style="min-height: 80px;"></textarea>
                    <div class="form-hint">JSON æ ¼å¼çš„ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚: {"API_KEY": "xxx"}</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddMCPModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveMCP()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- CC Switch ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="ccSwitchManagerModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ”„ CC Switch é…ç½®ç®¡ç†</h2>
                <button class="close-btn" onclick="closeCCSwitchManager()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #5f6368;">
                        ç®¡ç† Claude Code çš„ API ç«¯ç‚¹é…ç½®
                    </div>
                    <button class="btn btn-primary" onclick="openAddCCSwitchModal()" style="padding: 8px 16px; font-size: 13px;">
                        â• æ·»åŠ é…ç½®
                    </button>
                </div>

                <div id="ccSwitchList" style="max-height: 500px; overflow-y: auto;">
                    <!-- CC Switch åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCCSwitchManager()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ CC Switch é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="addCCSwitchModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="addCCSwitchModalTitle">â• æ·»åŠ é…ç½®</h2>
                <button class="close-btn" onclick="closeAddCCSwitchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">é…ç½®åç§°</label>
                    <input type="text" class="form-input" id="ccSwitchName" placeholder="ä¾‹å¦‚: foxcode-aws">
                    <div class="form-hint">ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦ï¼Œä¾‹å¦‚: duckcoding-kiro</div>
                </div>
                <div class="form-group">
                    <label class="form-label">API ç«¯ç‚¹ URL</label>
                    <input type="text" class="form-input" id="ccSwitchBaseUrl" placeholder="https://api.example.com">
                    <div class="form-hint">Claude API çš„åŸºç¡€ URL</div>
                </div>
                <div class="form-group">
                    <label class="form-label">è®¤è¯ä»¤ç‰Œ</label>
                    <input type="text" class="form-input" id="ccSwitchAuthToken" placeholder="sk-ant-...">
                    <div class="form-hint">API è®¤è¯ä»¤ç‰Œ</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddCCSwitchModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveCCSwitch()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Email é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="emailSettingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“§ Email é…ç½®</h2>
                <button class="close-btn" onclick="closeEmailSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">å‘é€é‚®ç®±ï¼ˆç”¨äºå‘é€é€šçŸ¥ï¼‰</label>
                    <input type="email" class="form-input" id="senderEmailInput" placeholder="your-email@163.com">
                    <div class="form-hint">ç”¨äºå‘é€é€šçŸ¥çš„é‚®ç®±åœ°å€</div>
                </div>
                <div class="form-group">
                    <label class="form-label">å‘é€é‚®ç®±å¯†ç /æˆæƒç </label>
                    <input type="password" class="form-input" id="senderPasswordInput" placeholder="è¾“å…¥é‚®ç®±å¯†ç æˆ–æˆæƒç ">
                    <div class="form-hint">163é‚®ç®±éœ€è¦ä½¿ç”¨æˆæƒç ï¼Œä¸æ˜¯ç™»å½•å¯†ç </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¥æ”¶é‚®ç®±ï¼ˆæ¥æ”¶é€šçŸ¥ï¼‰</label>
                    <input type="email" class="form-input" id="recipientEmailInput" placeholder="wu.xiguanghua@163.com">
                    <div class="form-hint">ä»»åŠ¡ç»“æœå°†å‘é€åˆ°æ­¤é‚®ç®±</div>
                </div>
                <div class="form-group">
                    <label class="form-label">SMTP æœåŠ¡å™¨</label>
                    <input type="text" class="form-input" id="smtpServerInput" placeholder="smtp.163.com">
                </div>
                <div class="form-group">
                    <label class="form-label">SMTP ç«¯å£</label>
                    <input type="number" class="form-input" id="smtpPortInput" placeholder="465">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailSettings()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEmailSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Telegram é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="telegramSettingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">âœˆï¸ Telegram é…ç½®</h2>
                <button class="close-btn" onclick="closeTelegramSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Bot Token</label>
                    <input type="text" class="form-input" id="telegramBotTokenInput" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                    <div class="form-hint">ä» @BotFather è·å–çš„ Bot Token</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Chat ID</label>
                    <input type="text" class="form-input" id="telegramChatIdInput" placeholder="123456789">
                    <div class="form-hint">ä½ çš„ Telegram Chat IDï¼Œå¯ä»¥ä» @userinfobot è·å–</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTelegramSettings()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveTelegramSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å®æ—¶è¿›åº¦é¢æ¿ -->
    <div class="progress-panel" id="progressPanel">
        <div class="progress-header">
            <div class="progress-title">
                <div class="progress-spinner"></div>
                <span>ä»»åŠ¡æ‰§è¡Œä¸­...</span>
            </div>
            <button class="progress-close" onclick="closeProgressPanel()">&times;</button>
        </div>
        <div class="progress-body" id="progressBody">
            <div class="progress-line">ç­‰å¾… Claude å“åº”...</div>
        </div>
        <div class="progress-footer">
            <div class="progress-status">
                <div class="status-dot"></div>
                <span>å®æ—¶è¾“å‡º</span>
            </div>
            <span id="progressLineCount">0 è¡Œ</span>
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let selectedTaskId = null;
        let allTasks = [];
        let progressPollingInterval = null;
        let currentExecutingTaskId = null;

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        updateTime();
        setInterval(updateTime, 1000);

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();

                const total = (stats['å¾…å¤„ç†'] || 0) + (stats['å¤„ç†ä¸­'] || 0) + (stats['å·²å®Œæˆ'] || 0) + (stats['å¤±è´¥'] || 0) + (stats['å·²å½’æ¡£'] || 0);
                document.getElementById('count-all').textContent = total;
                document.getElementById('count-å¾…å¤„ç†').textContent = stats['å¾…å¤„ç†'] || 0;
                document.getElementById('count-å¤„ç†ä¸­').textContent = stats['å¤„ç†ä¸­'] || 0;
                document.getElementById('count-å·²å®Œæˆ').textContent = stats['å·²å®Œæˆ'] || 0;
                document.getElementById('count-å¤±è´¥').textContent = stats['å¤±è´¥'] || 0;
                document.getElementById('count-å·²å½’æ¡£').textContent = stats['å·²å½’æ¡£'] || 0;
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', e);
            }
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                const status = currentFilter === 'all' ? '' : currentFilter;
                const url = `/api/tasks?status=${status}&limit=100`;

                const res = await fetch(url);
                allTasks = await res.json();

                renderTaskList(allTasks);
                updatePanelHeader();
            } catch (e) {
                console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList(tasks) {
            const container = document.getElementById('taskItems');
            container.innerHTML = '';

            if (tasks.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #9e9e9e;">æš‚æ— ä»»åŠ¡</div>';
                return;
            }

            tasks.forEach(task => {
                const item = createTaskItem(task);
                container.appendChild(item);
            });
        }

        // åˆ›å»ºä»»åŠ¡é¡¹
        function createTaskItem(task) {
            const div = document.createElement('div');
            div.className = 'task-item';
            if (task.id === selectedTaskId) {
                div.classList.add('selected');
            }

            const statusText = getStatusText(task.status);
            const timeText = formatRelativeTime(task.created_at);

            div.innerHTML = `
                <div class="task-item-header">
                    <span class="task-id-badge">${formatTaskId(task.id)}</span>
                    <span class="task-time">${timeText}</span>
                </div>
                <div class="task-preview">${task.message}</div>
                <span class="task-status-badge status-${task.status}">${statusText}</span>
            `;

            div.onclick = () => selectTask(task.id);
            return div;
        }

        // é€‰æ‹©ä»»åŠ¡
        async function selectTask(taskId) {
            selectedTaskId = taskId;

            // æ›´æ–°åˆ—è¡¨é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // åŠ è½½ä»»åŠ¡è¯¦æƒ…
            await loadTaskDetail(taskId);
        }

        // åŠ è½½ä»»åŠ¡è¯¦æƒ…
        async function loadTaskDetail(taskId) {
            try {
                const res = await fetch(`/api/tasks/${taskId}`);
                const task = await res.json();

                document.getElementById('detailEmpty').style.display = 'none';
                const detailContent = document.getElementById('detailContent');
                detailContent.classList.add('show');

                // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¿å­˜è¿›åº¦çŠ¶æ€
                const isExecuting = (currentExecutingTaskId === taskId);
                let progressHtml = '';
                if (isExecuting) {
                    const progressSection = document.getElementById(`taskProgress-${taskId}`);
                    if (progressSection) {
                        progressHtml = progressSection.outerHTML;
                    }
                }

                detailContent.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-actions">
                            <button class="action-btn primary" onclick="executeTask('${task.id}')">
                                <span>â–¶ï¸</span>
                                <span>æ‰§è¡Œä»»åŠ¡</span>
                            </button>
                            ${task.status === 'å¾…å¤„ç†' ? `
                                <button class="action-btn" onclick="editTask('${task.id}')">
                                    <span>âœï¸</span>
                                    <span>ç¼–è¾‘</span>
                                </button>
                                <button class="action-btn danger" onclick="deleteTask('${task.id}')">
                                    <span>ğŸ—‘ï¸</span>
                                    <span>åˆ é™¤</span>
                                </button>
                            ` : ''}
                            ${task.status === 'å·²å®Œæˆ' || task.status === 'å¤±è´¥' ? `
                                <button class="action-btn" onclick="archiveTask('${task.id}')">
                                    <span>ğŸ“¦</span>
                                    <span>å½’æ¡£</span>
                                </button>
                            ` : ''}
                        </div>
                        <div class="detail-meta">
                            <div class="meta-item">
                                <div class="meta-label">ä»»åŠ¡ ID</div>
                                <div class="meta-value">${task.id}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">çŠ¶æ€</div>
                                <div class="meta-value">${getStatusText(task.status)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">ä¼˜å…ˆçº§</div>
                                <div class="meta-value">${getPriorityText(task.priority)}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">åˆ›å»ºæ—¶é—´</div>
                                <div class="meta-value">${formatTime(task.created_at)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-body">
                        <div class="section-title">ä»»åŠ¡å†…å®¹</div>
                        <div class="message-box">${task.message}</div>

                        <!-- å®æ—¶æ‰§è¡Œè¿›åº¦åŒºåŸŸ -->
                        <div id="taskProgress-${task.id}" class="task-progress-section" style="display: ${isExecuting ? 'block' : 'none'};">
                            <div class="section-title">
                                <span>å®æ—¶æ‰§è¡Œè¿›åº¦</span>
                                <span class="progress-spinner" style="display: inline-block; margin-left: 8px;"></span>
                            </div>
                            <div class="progress-box">
                                <div class="progress-output" id="progressOutput-${task.id}">
                                    <div class="progress-line">ç­‰å¾… Claude å“åº”...</div>
                                </div>
                                <div class="progress-info">
                                    <span class="status-dot"></span>
                                    <span id="progressLineCount-${task.id}">0 è¡Œ</span>
                                </div>
                            </div>
                        </div>

                        ${task.result ? `
                            <div class="section-title">æ‰§è¡Œç»“æœ</div>
                            <div class="result-box">${task.result}</div>
                        ` : ''}
                        ${task.error ? `
                            <div class="section-title">é”™è¯¯ä¿¡æ¯</div>
                            <div class="error-box">${task.error}</div>
                        ` : ''}
                    </div>
                `;

                // å¦‚æœæ˜¯æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¢å¤è¿›åº¦æ˜¾ç¤º
                if (isExecuting && progressHtml) {
                    const newProgressSection = document.getElementById(`taskProgress-${taskId}`);
                    if (newProgressSection && progressHtml) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = progressHtml;
                        const oldProgressSection = tempDiv.firstChild;
                        if (oldProgressSection) {
                            newProgressSection.parentNode.replaceChild(oldProgressSection, newProgressSection);
                        }
                    }
                }
            } catch (e) {
                console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', e);
            }
        }

        // è¿‡æ»¤ä»»åŠ¡
        function filterTasks(filter, element) {
            currentFilter = filter;
            selectedTaskId = null;

            // æ›´æ–°å¯¼èˆªæ æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');

            // éšè—è¯¦æƒ…é¢æ¿
            document.getElementById('detailEmpty').style.display = 'flex';
            document.getElementById('detailContent').classList.remove('show');

            loadTasks();
        }

        // æ›´æ–°é¢æ¿æ ‡é¢˜
        function updatePanelHeader() {
            const titles = {
                'all': 'å…¨éƒ¨ä»»åŠ¡',
                'inbox': 'å¾…å¤„ç†',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            document.getElementById('panelTitle').textContent = titles[currentFilter];
            document.getElementById('panelSubtitle').textContent = `å…± ${allTasks.length} ä¸ªä»»åŠ¡`;
        }

        // æ‰“å¼€æ–°å»ºä»»åŠ¡æ¨¡æ€æ¡†
        function openComposeModal() {
            document.getElementById('composeModal').classList.add('show');
            document.getElementById('taskMessage').value = '';
            document.getElementById('taskPriority').value = 'normal';
        }

        // å…³é—­æ–°å»ºä»»åŠ¡æ¨¡æ€æ¡†
        function closeComposeModal() {
            document.getElementById('composeModal').classList.remove('show');
        }

        // åˆ›å»ºä»»åŠ¡
        async function createTask() {
            const message = document.getElementById('taskMessage').value.trim();
            const priority = document.getElementById('taskPriority').value;

            if (!message) {
                alert('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹');
                return;
            }

            try {
                const res = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: 'web_user',
                        message: message,
                        priority: priority
                    })
                });

                const result = await res.json();
                if (result.success) {
                    closeComposeModal();
                    loadStats();
                    loadTasks();
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }

        // æ‰§è¡Œä»»åŠ¡
        async function executeTask(taskId) {
            if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ­¤ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                // æ˜¾ç¤ºä»»åŠ¡å†…åµŒçš„è¿›åº¦åŒºåŸŸ
                const progressSection = document.getElementById(`taskProgress-${taskId}`);
                if (progressSection) {
                    progressSection.style.display = 'block';
                    currentExecutingTaskId = taskId;
                }

                const res = await fetch(`/api/tasks/${taskId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const result = await res.json();
                if (result.success) {
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    startProgressPolling(taskId);
                } else {
                    alert('æ‰§è¡Œå¤±è´¥: ' + result.error);
                    if (progressSection) {
                        progressSection.style.display = 'none';
                    }
                }
            } catch (e) {
                alert('æ‰§è¡Œå¤±è´¥: ' + e.message);
                const progressSection = document.getElementById(`taskProgress-${taskId}`);
                if (progressSection) {
                    progressSection.style.display = 'none';
                }
            }
        }

        // æ˜¾ç¤ºè¿›åº¦é¢æ¿
        function showProgressPanel(taskId) {
            currentExecutingTaskId = taskId;
            document.getElementById('progressPanel').classList.add('show');
            document.getElementById('progressBody').innerHTML = '<div class="progress-line">ç­‰å¾… Claude å“åº”...</div>';
            document.getElementById('progressLineCount').textContent = '0 è¡Œ';
        }

        // å…³é—­è¿›åº¦é¢æ¿
        function closeProgressPanel() {
            document.getElementById('progressPanel').classList.remove('show');
            stopProgressPolling();

            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å’Œè¯¦æƒ…
            if (currentExecutingTaskId) {
                loadStats();
                loadTasks();
                loadTaskDetail(currentExecutingTaskId);
                currentExecutingTaskId = null;
            }
        }

        // å¼€å§‹è½®è¯¢è¿›åº¦
        function startProgressPolling(taskId) {
            stopProgressPolling(); // å…ˆåœæ­¢ä¹‹å‰çš„è½®è¯¢

            progressPollingInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/tasks/${taskId}/progress`);
                    if (res.status === 404) {
                        // è¿›åº¦ä¸å­˜åœ¨ï¼Œå¯èƒ½è¿˜æ²¡å¼€å§‹
                        return;
                    }

                    const progress = await res.json();
                    updateTaskProgress(taskId, progress);

                    // å¦‚æœä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
                    if (progress.completed) {
                        stopProgressPolling();

                        // å»¶è¿Ÿåˆ·æ–°ä»»åŠ¡è¯¦æƒ…ï¼Œæ˜¾ç¤ºæœ€ç»ˆç»“æœ
                        setTimeout(() => {
                            loadStats();
                            loadTasks();
                            loadTaskDetail(taskId);
                            currentExecutingTaskId = null;
                        }, 2000);
                    }
                } catch (e) {
                    console.error('è½®è¯¢è¿›åº¦å¤±è´¥:', e);
                }
            }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
        }

        // åœæ­¢è½®è¯¢è¿›åº¦
        function stopProgressPolling() {
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
        }

        // æ›´æ–°ä»»åŠ¡å†…åµŒçš„è¿›åº¦æ˜¾ç¤º
        function updateTaskProgress(taskId, progress) {
            const outputEl = document.getElementById(`progressOutput-${taskId}`);
            const countEl = document.getElementById(`progressLineCount-${taskId}`);

            if (!outputEl) return;

            const lines = progress.lines || [];

            if (lines.length === 0) {
                outputEl.innerHTML = '<div class="progress-line">ç­‰å¾…è¾“å‡º...</div>';
                return;
            }

            // æ¸²æŸ“æ‰€æœ‰è¡Œ
            outputEl.innerHTML = lines.map(line =>
                `<div class="progress-line">${escapeHtml(line)}</div>`
            ).join('');

            // æ›´æ–°è¡Œæ•°
            if (countEl) {
                countEl.textContent = `${lines.length} è¡Œ`;
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            outputEl.scrollTop = outputEl.scrollHeight;

            // å¦‚æœå®Œæˆï¼Œéšè— spinner
            if (progress.completed) {
                const progressSection = document.getElementById(`taskProgress-${taskId}`);
                if (progressSection) {
                    const spinner = progressSection.querySelector('.progress-spinner');
                    if (spinner) {
                        spinner.style.display = 'none';
                    }
                }
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                const result = await res.json();
                if (result.success) {
                    selectedTaskId = null;
                    document.getElementById('detailEmpty').style.display = 'flex';
                    document.getElementById('detailContent').classList.remove('show');
                    loadStats();
                    loadTasks();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // å½’æ¡£ä»»åŠ¡
        async function archiveTask(taskId) {
            if (!confirm('ç¡®å®šè¦å½’æ¡£æ­¤ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/tasks/${taskId}/archive`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const result = await res.json();
                if (result.success) {
                    loadStats();
                    loadTasks();
                    loadTaskDetail(taskId);
                    alert('å½’æ¡£æˆåŠŸï¼');
                } else {
                    alert('å½’æ¡£å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('å½’æ¡£å¤±è´¥: ' + e.message);
            }
        }

        // æ ¼å¼åŒ–å‡½æ•°
        function formatTaskId(taskId) {
            // task_20260214_151132_338481 -> 0214-1511
            const parts = taskId.split('_');
            if (parts.length >= 3) {
                const date = parts[1]; // 20260214
                const time = parts[2]; // 151132
                return date.substring(4, 8) + '-' + time.substring(0, 4);
            }
            return taskId.substring(0, 12);
        }

        function getStatusText(status) {
            // çŠ¶æ€å·²ç»æ˜¯ä¸­æ–‡ï¼Œç›´æ¥è¿”å›
            return status;
        }

        function getPriorityText(priority) {
            const map = {
                'normal': 'æ™®é€š',
                'high': 'é«˜ä¼˜å…ˆçº§',
                'urgent': 'ç´§æ€¥'
            };
            return map[priority] || priority;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '-';
            return new Date(timeStr).toLocaleString('zh-CN');
        }

        function formatRelativeTime(timeStr) {
            if (!timeStr) return '-';
            const now = new Date();
            const time = new Date(timeStr);
            const diff = Math.floor((now - time) / 1000);

            if (diff < 60) return 'åˆšåˆš';
            if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
            if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
            if (diff < 604800) return Math.floor(diff / 86400) + 'å¤©å‰';
            return formatTime(timeStr);
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            if (!keyword) {
                renderTaskList(allTasks);
                return;
            }

            const filtered = allTasks.filter(task =>
                task.message.toLowerCase().includes(keyword) ||
                task.id.toLowerCase().includes(keyword)
            );
            renderTaskList(filtered);
        });

        // ========== è‡ªåŠ¨å·¡èˆªåŠŸèƒ½ ==========

        let autoCountdownInterval = null;
        let lastCountdown = 0;

        // åŠ è½½è‡ªåŠ¨å·¡èˆªçŠ¶æ€
        async function loadAutoExecutorStatus() {
            try {
                const res = await fetch('/api/auto-executor/status');
                const status = await res.json();

                // æ›´æ–°å¼€å…³çŠ¶æ€
                document.getElementById('autoExecutorToggle').checked = status.enabled;

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                document.getElementById('autoPendingCount').textContent = status.pending_count || 0;
                document.getElementById('autoQueueSize').textContent = status.queue_size || 0;
                document.getElementById('autoProcessingCount').textContent = status.processing_count || 0;
                document.getElementById('autoWorkerCount').textContent = status.worker_count || 0;

                // å¦‚æœè‡ªåŠ¨å·¡èˆªå·²ç¦ç”¨ï¼Œç›´æ¥åœæ­¢å€’è®¡æ—¶
                if (!status.enabled) {
                    stopCountdownTimer();
                    return;
                }

                // æ›´æ–°å€’è®¡æ—¶
                lastCountdown = status.countdown || 0;
                updateCountdownDisplay();

                // å¯åŠ¨å€’è®¡æ—¶æ›´æ–°
                if (!autoCountdownInterval) {
                    startCountdownTimer();
                }
            } catch (e) {
                console.error('åŠ è½½è‡ªåŠ¨å·¡èˆªçŠ¶æ€å¤±è´¥:', e);
            }
        }

        // å¯åŠ¨å€’è®¡æ—¶å®šæ—¶å™¨
        function startCountdownTimer() {
            if (autoCountdownInterval) return;

            autoCountdownInterval = setInterval(() => {
                if (lastCountdown > 0) {
                    lastCountdown--;
                    updateCountdownDisplay();
                }
            }, 1000);
        }

        // åœæ­¢å€’è®¡æ—¶å®šæ—¶å™¨
        function stopCountdownTimer() {
            if (autoCountdownInterval) {
                clearInterval(autoCountdownInterval);
                autoCountdownInterval = null;
            }
            document.getElementById('autoCountdown').textContent = '-';
        }

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('autoCountdown');
            if (!countdownEl) return;

            if (lastCountdown <= 0) {
                countdownEl.textContent = 'æ£€æŸ¥ä¸­...';
                countdownEl.style.color = '#ff9800';
            } else {
                const minutes = Math.floor(lastCountdown / 60);
                const seconds = lastCountdown % 60;
                if (minutes > 0) {
                    countdownEl.textContent = `${minutes}åˆ†${seconds}ç§’`;
                } else {
                    countdownEl.textContent = `${seconds}ç§’`;
                }
                countdownEl.style.color = '#1a73e8';
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨å·¡èˆªå¼€å…³
        async function toggleAutoExecutor() {
            const enabled = document.getElementById('autoExecutorToggle').checked;

            try {
                const res = await fetch('/api/auto-executor/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const result = await res.json();
                if (result.success) {
                    console.log(result.message);

                    // å¦‚æœç¦ç”¨ï¼Œç«‹å³åœæ­¢å€’è®¡æ—¶
                    if (!enabled) {
                        stopCountdownTimer();
                    }

                    loadAutoExecutorStatus();
                } else {
                    alert('åˆ‡æ¢å¤±è´¥: ' + result.error);
                    document.getElementById('autoExecutorToggle').checked = !enabled;
                }
            } catch (e) {
                alert('åˆ‡æ¢å¤±è´¥: ' + e.message);
                document.getElementById('autoExecutorToggle').checked = !enabled;
            }
        }

        // æ‰“å¼€è‡ªåŠ¨å·¡èˆªè®¾ç½®å¯¹è¯æ¡†
        async function openAutoExecutorSettings() {
            try {
                // åŠ è½½å½“å‰é…ç½®
                const res = await fetch('/api/auto-executor/config');
                const config = await res.json();

                // å¡«å……è¡¨å•
                document.getElementById('settingInterval').value = config.interval || 60;
                document.getElementById('settingMaxConcurrent').value = config.max_concurrent || 1;

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('autoExecutorSettingsModal').classList.add('show');
            } catch (e) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
                alert('åŠ è½½é…ç½®å¤±è´¥: ' + e.message);
            }
        }

        // å…³é—­è‡ªåŠ¨å·¡èˆªè®¾ç½®å¯¹è¯æ¡†
        function closeAutoExecutorSettings() {
            document.getElementById('autoExecutorSettingsModal').classList.remove('show');
        }

        // ä¿å­˜è‡ªåŠ¨å·¡èˆªè®¾ç½®
        async function saveAutoExecutorSettings() {
            const interval = parseInt(document.getElementById('settingInterval').value);
            const maxConcurrent = parseInt(document.getElementById('settingMaxConcurrent').value);

            // éªŒè¯è¾“å…¥
            if (!interval || interval < 10 || interval > 3600) {
                alert('æ£€æŸ¥é—´éš”å¿…é¡»åœ¨ 10-3600 ç§’ä¹‹é—´');
                return;
            }

            if (!maxConcurrent || maxConcurrent < 1 || maxConcurrent > 10) {
                alert('æœ€å¤§å¹¶å‘æ•°å¿…é¡»åœ¨ 1-10 ä¹‹é—´');
                return;
            }

            await updateAutoExecutorConfig({
                interval: interval,
                max_concurrent: maxConcurrent
            });

            closeAutoExecutorSettings();
        }

        // æ›´æ–°è‡ªåŠ¨å·¡èˆªé…ç½®
        async function updateAutoExecutorConfig(config) {
            try {
                const res = await fetch('/api/auto-executor/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await res.json();
                if (result.success) {
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const message = document.createElement('div');
                    message.style.cssText = 'position: fixed; top: 80px; right: 24px; background: #4caf50; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-size: 14px;';
                    message.textContent = 'âœ“ é…ç½®å·²æ›´æ–°';
                    document.body.appendChild(message);
                    setTimeout(() => message.remove(), 3000);

                    loadAutoExecutorStatus();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('æ›´æ–°å¤±è´¥: ' + e.message);
            }
        }

        // ========== MCP ç®¡ç†åŠŸèƒ½ ==========

        let currentEditingMCP = null;

        // åŠ è½½ MCP åˆ—è¡¨
        async function loadMCPList() {
            try {
                const res = await fetch('/api/mcp/list');
                const mcps = await res.json();

                // æ›´æ–° MCP æ•°é‡æ˜¾ç¤º
                document.getElementById('mcpCount').textContent = mcps.length;

                const container = document.getElementById('mcpList');
                if (mcps.length === 0) {
                    container.innerHTML = '<div style="padding: 40px; text-align: center; color: #9e9e9e;">æš‚æ—  MCP é…ç½®</div>';
                    return;
                }

                container.innerHTML = mcps.map(mcp => `
                    <div style="padding: 16px; border: 1px solid #dadce0; border-radius: 8px; margin-bottom: 12px; background: #fff;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 15px; font-weight: 500; color: #202124; margin-bottom: 4px;">
                                    ${mcp.name}
                                </div>
                                <div style="font-size: 12px; color: #5f6368; font-family: monospace;">
                                    ${mcp.command} ${mcp.args.join(' ')}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editMCP('${mcp.name}')" style="padding: 6px 12px; background: #fff; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer; font-size: 12px; color: #1a73e8;">
                                    âœï¸ ç¼–è¾‘
                                </button>
                                <button onclick="deleteMCP('${mcp.name}')" style="padding: 6px 12px; background: #fff; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer; font-size: 12px; color: #d93025;">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                        ${Object.keys(mcp.env || {}).length > 0 ? `
                            <div style="font-size: 12px; color: #5f6368; margin-top: 8px;">
                                ç¯å¢ƒå˜é‡: ${Object.keys(mcp.env).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½ MCP åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        // æ‰“å¼€ MCP ç®¡ç†å™¨
        function openMCPManager() {
            loadMCPList();
            document.getElementById('mcpManagerModal').classList.add('show');
        }

        // å…³é—­ MCP ç®¡ç†å™¨
        function closeMCPManager() {
            document.getElementById('mcpManagerModal').classList.remove('show');
        }

        // æ‰“å¼€æ·»åŠ  MCP æ¨¡æ€æ¡†
        function openAddMCPModal() {
            currentEditingMCP = null;
            document.getElementById('addMCPModalTitle').textContent = 'â• æ·»åŠ  MCP';
            document.getElementById('mcpName').value = '';
            document.getElementById('mcpName').disabled = false;
            document.getElementById('mcpCommand').value = 'python';
            document.getElementById('mcpArgs').value = '';
            document.getElementById('mcpEnv').value = '';
            document.getElementById('addMCPModal').classList.add('show');
        }

        // å…³é—­æ·»åŠ  MCP æ¨¡æ€æ¡†
        function closeAddMCPModal() {
            document.getElementById('addMCPModal').classList.remove('show');
        }

        // ç¼–è¾‘ MCP
        async function editMCP(name) {
            try {
                const res = await fetch(`/api/mcp/${name}`);
                const mcp = await res.json();

                currentEditingMCP = name;
                document.getElementById('addMCPModalTitle').textContent = 'âœï¸ ç¼–è¾‘ MCP';
                document.getElementById('mcpName').value = mcp.name;
                document.getElementById('mcpName').disabled = true;
                document.getElementById('mcpCommand').value = mcp.command;
                document.getElementById('mcpArgs').value = mcp.args.join(' ');
                document.getElementById('mcpEnv').value = Object.keys(mcp.env || {}).length > 0 ? JSON.stringify(mcp.env, null, 2) : '';
                document.getElementById('addMCPModal').classList.add('show');
            } catch (e) {
                alert('åŠ è½½ MCP ä¿¡æ¯å¤±è´¥: ' + e.message);
            }
        }

        // ä¿å­˜ MCP
        async function saveMCP() {
            const name = document.getElementById('mcpName').value.trim();
            const command = document.getElementById('mcpCommand').value.trim();
            const argsStr = document.getElementById('mcpArgs').value.trim();
            const envStr = document.getElementById('mcpEnv').value.trim();

            if (!name || !command || !argsStr) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ');
                return;
            }

            // è§£æå‚æ•°
            const args = [argsStr];

            // è§£æç¯å¢ƒå˜é‡
            let env = null;
            if (envStr) {
                try {
                    env = JSON.parse(envStr);
                } catch (e) {
                    alert('ç¯å¢ƒå˜é‡ JSON æ ¼å¼é”™è¯¯');
                    return;
                }
            }

            try {
                const url = currentEditingMCP ? `/api/mcp/${currentEditingMCP}` : '/api/mcp';
                const method = currentEditingMCP ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, command, args, env})
                });

                const result = await res.json();
                if (result.success || res.ok) {
                    closeAddMCPModal();
                    loadMCPList();
                    alert(currentEditingMCP ? 'MCP æ›´æ–°æˆåŠŸ' : 'MCP æ·»åŠ æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤ MCP
        async function deleteMCP(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ MCP "${name}" å—ï¼Ÿ`)) return;

            try {
                const res = await fetch(`/api/mcp/${name}`, {
                    method: 'DELETE'
                });

                const result = await res.json();
                if (result.success) {
                    loadMCPList();
                    alert('MCP åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // æ‰«ææœ¬åœ° MCPs
        async function scanLocalMCPs() {
            try {
                const res = await fetch('/api/mcp/scan');
                const discovered = await res.json();

                if (discovered.length === 0) {
                    alert('æœªå‘ç°æ–°çš„ MCP');
                    return;
                }

                const message = `å‘ç° ${discovered.length} ä¸ª MCP:\n\n` +
                    discovered.map(m => `- ${m.display_name}`).join('\n') +
                    '\n\næ˜¯å¦è¦æ·»åŠ è¿™äº› MCPï¼Ÿ';

                if (confirm(message)) {
                    let added = 0;
                    for (const mcp of discovered) {
                        try {
                            const res = await fetch('/api/mcp', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    name: mcp.name,
                                    command: mcp.command,
                                    args: mcp.args
                                })
                            });
                            if (res.ok) added++;
                        } catch (e) {
                            console.error(`æ·»åŠ  ${mcp.name} å¤±è´¥:`, e);
                        }
                    }
                    loadMCPList();
                    alert(`æˆåŠŸæ·»åŠ  ${added}/${discovered.length} ä¸ª MCP`);
                }
            } catch (e) {
                alert('æ‰«æå¤±è´¥: ' + e.message);
            }
        }

        // ========== CC Switch ç®¡ç†åŠŸèƒ½ ==========

        let currentEditingCCSwitch = null;

        // åŠ è½½ CC Switch åˆ—è¡¨
        async function loadCCSwitchList() {
            try {
                const res = await fetch('/api/cc-switch/list');
                const profiles = await res.json();

                // æ›´æ–°é…ç½®æ•°é‡æ˜¾ç¤º
                document.getElementById('ccSwitchCount').textContent = profiles.length;

                // æ›´æ–°å½“å‰é…ç½®æ˜¾ç¤º
                const current = profiles.find(p => p.is_current);
                if (current) {
                    document.getElementById('ccSwitchCurrent').textContent = current.name;
                    document.getElementById('ccSwitchCurrent').style.color = '#137333';
                } else {
                    document.getElementById('ccSwitchCurrent').textContent = 'æœªè®¾ç½®';
                    document.getElementById('ccSwitchCurrent').style.color = '#5f6368';
                }

                const container = document.getElementById('ccSwitchList');
                if (profiles.length === 0) {
                    container.innerHTML = '<div style="padding: 40px; text-align: center; color: #9e9e9e;">æš‚æ— é…ç½®</div>';
                    return;
                }

                container.innerHTML = profiles.map(profile => `
                    <div style="padding: 16px; border: 1px solid ${profile.is_current ? '#4caf50' : '#dadce0'}; border-radius: 8px; margin-bottom: 12px; background: ${profile.is_current ? '#e8f5e9' : '#fff'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <div style="font-size: 15px; font-weight: 500; color: #202124;">
                                        ${profile.name}
                                    </div>
                                    ${profile.is_current ? '<span style="padding: 2px 8px; background: #4caf50; color: white; border-radius: 12px; font-size: 11px; font-weight: 600;">å½“å‰</span>' : ''}
                                </div>
                                <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">
                                    ${profile.base_url}
                                </div>
                                <div style="font-size: 11px; color: #9e9e9e; font-family: monospace;">
                                    ${profile.auth_token.substring(0, 30)}...
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                ${!profile.is_current ? `
                                    <button onclick="switchCCSwitch('${profile.name}')" style="padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
                                        âœ“ åˆ‡æ¢
                                    </button>
                                ` : ''}
                                <button onclick="editCCSwitch('${profile.name}')" style="padding: 6px 12px; background: #fff; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer; font-size: 12px; color: #1a73e8;">
                                    âœï¸ ç¼–è¾‘
                                </button>
                                <button onclick="deleteCCSwitch('${profile.name}')" style="padding: 6px 12px; background: #fff; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer; font-size: 12px; color: #d93025;">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½ CC Switch åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        // æ‰“å¼€ CC Switch ç®¡ç†å™¨
        function openCCSwitchManager() {
            loadCCSwitchList();
            document.getElementById('ccSwitchManagerModal').classList.add('show');
        }

        // å…³é—­ CC Switch ç®¡ç†å™¨
        function closeCCSwitchManager() {
            document.getElementById('ccSwitchManagerModal').classList.remove('show');
        }

        // æ‰“å¼€æ·»åŠ  CC Switch é…ç½®æ¨¡æ€æ¡†
        function openAddCCSwitchModal() {
            currentEditingCCSwitch = null;
            document.getElementById('addCCSwitchModalTitle').textContent = 'â• æ·»åŠ é…ç½®';
            document.getElementById('ccSwitchName').value = '';
            document.getElementById('ccSwitchName').disabled = false;
            document.getElementById('ccSwitchBaseUrl').value = '';
            document.getElementById('ccSwitchAuthToken').value = '';
            document.getElementById('addCCSwitchModal').classList.add('show');
        }

        // å…³é—­æ·»åŠ  CC Switch é…ç½®æ¨¡æ€æ¡†
        function closeAddCCSwitchModal() {
            document.getElementById('addCCSwitchModal').classList.remove('show');
        }

        // ç¼–è¾‘ CC Switch é…ç½®
        async function editCCSwitch(name) {
            try {
                const res = await fetch('/api/cc-switch/list');
                const profiles = await res.json();
                const profile = profiles.find(p => p.name === name);

                if (!profile) {
                    alert('é…ç½®ä¸å­˜åœ¨');
                    return;
                }

                currentEditingCCSwitch = name;
                document.getElementById('addCCSwitchModalTitle').textContent = 'âœï¸ ç¼–è¾‘é…ç½®';
                document.getElementById('ccSwitchName').value = profile.name;
                document.getElementById('ccSwitchName').disabled = true;
                document.getElementById('ccSwitchBaseUrl').value = profile.base_url;
                document.getElementById('ccSwitchAuthToken').value = profile.auth_token;
                document.getElementById('addCCSwitchModal').classList.add('show');
            } catch (e) {
                alert('åŠ è½½é…ç½®ä¿¡æ¯å¤±è´¥: ' + e.message);
            }
        }

        // ä¿å­˜ CC Switch é…ç½®
        async function saveCCSwitch() {
            const name = document.getElementById('ccSwitchName').value.trim();
            const baseUrl = document.getElementById('ccSwitchBaseUrl').value.trim();
            const authToken = document.getElementById('ccSwitchAuthToken').value.trim();

            if (!name || !baseUrl || !authToken) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ');
                return;
            }

            try {
                const url = currentEditingCCSwitch ? `/api/cc-switch/${currentEditingCCSwitch}` : '/api/cc-switch';
                const method = currentEditingCCSwitch ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, base_url: baseUrl, auth_token: authToken})
                });

                const result = await res.json();
                if (result.success || res.ok) {
                    closeAddCCSwitchModal();
                    loadCCSwitchList();
                    alert(currentEditingCCSwitch ? 'é…ç½®æ›´æ–°æˆåŠŸ' : 'é…ç½®æ·»åŠ æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤ CC Switch é…ç½®
        async function deleteCCSwitch(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é…ç½® "${name}" å—ï¼Ÿ`)) return;

            try {
                const res = await fetch(`/api/cc-switch/${name}`, {
                    method: 'DELETE'
                });

                const result = await res.json();
                if (result.success) {
                    loadCCSwitchList();
                    alert('é…ç½®åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // åˆ‡æ¢ CC Switch é…ç½®
        async function switchCCSwitch(name) {
            if (!confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°é…ç½® "${name}" å—ï¼Ÿ`)) return;

            try {
                const res = await fetch(`/api/cc-switch/${name}/switch`, {
                    method: 'POST'
                });

                const result = await res.json();
                if (result.success) {
                    loadCCSwitchList();
                    alert('åˆ‡æ¢æˆåŠŸï¼');
                } else {
                    alert('åˆ‡æ¢å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('åˆ‡æ¢å¤±è´¥: ' + e.message);
            }
        }

        // ========== å†å²ä¸Šä¸‹æ–‡ç®¡ç† ==========

        // åŠ è½½å†å²ä¸Šä¸‹æ–‡çŠ¶æ€
        async function loadHistoryContextStatus() {
            try {
                // åŠ è½½é…ç½®
                const configRes = await fetch('/api/history/config');
                const config = await configRes.json();
                document.getElementById('historyContextToggle').checked = config.enabled;

                // åŠ è½½ç»Ÿè®¡
                const statsRes = await fetch('/api/history/stats');
                const stats = await statsRes.json();
                document.getElementById('historyTotalCount').textContent = stats.total || 0;
                document.getElementById('historyMaxCount').textContent = stats.max_count || 5;
            } catch (e) {
                console.error('åŠ è½½å†å²ä¸Šä¸‹æ–‡çŠ¶æ€å¤±è´¥:', e);
            }
        }

        // åˆ‡æ¢å†å²ä¸Šä¸‹æ–‡å¼€å…³
        async function toggleHistoryContext() {
            const enabled = document.getElementById('historyContextToggle').checked;

            try {
                const res = await fetch('/api/history/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const result = await res.json();
                if (result.success) {
                    console.log('å†å²ä¸Šä¸‹æ–‡å·²' + (enabled ? 'å¯ç”¨' : 'ç¦ç”¨'));
                    loadHistoryContextStatus();
                } else {
                    alert('åˆ‡æ¢å¤±è´¥: ' + result.error);
                    document.getElementById('historyContextToggle').checked = !enabled;
                }
            } catch (e) {
                alert('åˆ‡æ¢å¤±è´¥: ' + e.message);
                document.getElementById('historyContextToggle').checked = !enabled;
            }
        }

        // æ¸…é™¤å†å²è®°å½•
        async function clearHistoryRecords() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²ä¸Šä¸‹æ–‡è®°å½•å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ‰€æœ‰å†å²ä¸Šä¸‹æ–‡ï¼Œä½†ä¸ä¼šå½±å“ä»»åŠ¡è®°å½•æœ¬èº«ã€‚')) return;

            try {
                const res = await fetch('/api/history/clear', {
                    method: 'POST'
                });

                const result = await res.json();
                if (result.success) {
                    alert(`å†å²ä¸Šä¸‹æ–‡å·²æ¸…é™¤ï¼Œå…±åˆ é™¤ ${result.affected} æ¡è®°å½•`);
                    loadHistoryContextStatus();
                } else {
                    alert('æ¸…é™¤å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('æ¸…é™¤å¤±è´¥: ' + e.message);
            }
        }

        // ========== Email é…ç½®ç®¡ç† ==========

        // åŠ è½½ Email é…ç½®çŠ¶æ€
        async function loadEmailStatus() {
            try {
                const res = await fetch('/api/email/config');
                const config = await res.json();
                document.getElementById('emailToggle').checked = config.enabled;
                document.getElementById('emailAddress').textContent = config.recipient_email || '-';
            } catch (e) {
                console.error('åŠ è½½ Email é…ç½®å¤±è´¥:', e);
            }
        }

        // åˆ‡æ¢ Email å¼€å…³
        async function toggleEmail() {
            const enabled = document.getElementById('emailToggle').checked;

            try {
                const res = await fetch('/api/email/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const result = await res.json();
                if (result.success) {
                    console.log('Email å·²' + (enabled ? 'å¯ç”¨' : 'ç¦ç”¨'));
                } else {
                    alert('åˆ‡æ¢å¤±è´¥: ' + result.error);
                    document.getElementById('emailToggle').checked = !enabled;
                }
            } catch (e) {
                alert('åˆ‡æ¢å¤±è´¥: ' + e.message);
                document.getElementById('emailToggle').checked = !enabled;
            }
        }

        // æ‰“å¼€ Email è®¾ç½®
        async function openEmailSettings() {
            try {
                const res = await fetch('/api/email/config');
                const config = await res.json();

                document.getElementById('senderEmailInput').value = config.sender_email || '';
                document.getElementById('recipientEmailInput').value = config.recipient_email || 'wu.xiguanghua@163.com';
                document.getElementById('smtpServerInput').value = config.smtp_server || 'smtp.163.com';
                document.getElementById('smtpPortInput').value = config.smtp_port || 465;
                document.getElementById('senderPasswordInput').value = '';

                document.getElementById('emailSettingsModal').classList.add('show');
            } catch (e) {
                alert('åŠ è½½é…ç½®å¤±è´¥: ' + e.message);
            }
        }

        // å…³é—­ Email è®¾ç½®
        function closeEmailSettings() {
            document.getElementById('emailSettingsModal').classList.remove('show');
        }

        // ä¿å­˜ Email è®¾ç½®
        async function saveEmailSettings() {
            const senderEmail = document.getElementById('senderEmailInput').value;
            const senderPassword = document.getElementById('senderPasswordInput').value;
            const recipientEmail = document.getElementById('recipientEmailInput').value;
            const smtpServer = document.getElementById('smtpServerInput').value;
            const smtpPort = parseInt(document.getElementById('smtpPortInput').value);

            if (!senderEmail || !recipientEmail) {
                alert('è¯·è¾“å…¥å‘é€é‚®ç®±å’Œæ¥æ”¶é‚®ç®±');
                return;
            }

            try {
                const data = {
                    sender_email: senderEmail,
                    recipient_email: recipientEmail,
                    smtp_server: smtpServer,
                    smtp_port: smtpPort
                };

                if (senderPassword) {
                    data.sender_password = senderPassword;
                }

                const res = await fetch('/api/email/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                    closeEmailSettings();
                    loadEmailStatus();
                    alert('Email é…ç½®ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // ========== Telegram é…ç½®ç®¡ç† ==========

        // åŠ è½½ Telegram é…ç½®çŠ¶æ€
        async function loadTelegramStatus() {
            try {
                const res = await fetch('/api/telegram-config/config');
                const config = await res.json();
                document.getElementById('telegramToggle').checked = config.enabled;
                document.getElementById('telegramChatId').textContent = config.chat_id || '-';
            } catch (e) {
                console.error('åŠ è½½ Telegram é…ç½®å¤±è´¥:', e);
            }
        }

        // åˆ‡æ¢ Telegram å¼€å…³
        async function toggleTelegram() {
            const enabled = document.getElementById('telegramToggle').checked;

            try {
                const res = await fetch('/api/telegram-config/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const result = await res.json();
                if (result.success) {
                    console.log('Telegram å·²' + (enabled ? 'å¯ç”¨' : 'ç¦ç”¨'));
                } else {
                    alert('åˆ‡æ¢å¤±è´¥: ' + result.error);
                    document.getElementById('telegramToggle').checked = !enabled;
                }
            } catch (e) {
                alert('åˆ‡æ¢å¤±è´¥: ' + e.message);
                document.getElementById('telegramToggle').checked = !enabled;
            }
        }

        // æ‰“å¼€ Telegram è®¾ç½®
        async function openTelegramSettings() {
            try {
                const res = await fetch('/api/telegram-config/config');
                const config = await res.json();

                document.getElementById('telegramBotTokenInput').value = config.bot_token || '';
                document.getElementById('telegramChatIdInput').value = config.chat_id || '';

                document.getElementById('telegramSettingsModal').classList.add('show');
            } catch (e) {
                alert('åŠ è½½é…ç½®å¤±è´¥: ' + e.message);
            }
        }

        // å…³é—­ Telegram è®¾ç½®
        function closeTelegramSettings() {
            document.getElementById('telegramSettingsModal').classList.remove('show');
        }

        // ä¿å­˜ Telegram è®¾ç½®
        async function saveTelegramSettings() {
            const botToken = document.getElementById('telegramBotTokenInput').value;
            const chatId = document.getElementById('telegramChatIdInput').value;

            if (!botToken || !chatId) {
                alert('è¯·è¾“å…¥ Bot Token å’Œ Chat ID');
                return;
            }

            try {
                const res = await fetch('/api/telegram-config/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bot_token: botToken,
                        chat_id: chatId
                    })
                });

                const result = await res.json();
                if (result.success) {
                    closeTelegramSettings();
                    loadTelegramStatus();
                    alert('Telegram é…ç½®ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆå§‹åŒ–
        loadStats();
        loadTasks();
        loadAutoExecutorStatus();
        loadMCPList();  // åŠ è½½ MCP åˆ—è¡¨
        loadCCSwitchList();  // åŠ è½½ CC Switch åˆ—è¡¨
        loadHistoryContextStatus();  // åŠ è½½å†å²ä¸Šä¸‹æ–‡çŠ¶æ€
        loadEmailStatus();  // åŠ è½½ Email çŠ¶æ€
        loadTelegramStatus();  // åŠ è½½ Telegram çŠ¶æ€

        // å®šæœŸåˆ·æ–°ç»Ÿè®¡å’Œä»»åŠ¡åˆ—è¡¨ï¼ˆæ›´é¢‘ç¹ï¼Œä»¥ä¾¿åŠæ—¶çœ‹åˆ°çŠ¶æ€å˜åŒ–ï¼‰
        setInterval(loadStats, 5000);  // 5ç§’åˆ·æ–°ç»Ÿè®¡
        setInterval(() => {
            // åªåœ¨æ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ—¶åˆ·æ–°åˆ—è¡¨ï¼Œé¿å…å¹²æ‰°è¿›åº¦æ˜¾ç¤º
            if (!currentExecutingTaskId) {
                loadTasks();
            }
        }, 10000);  // 10ç§’åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        setInterval(loadAutoExecutorStatus, 5000);  // 5ç§’åˆ·æ–°è‡ªåŠ¨å·¡èˆªçŠ¶æ€
        setInterval(loadHistoryContextStatus, 10000);  // 10ç§’åˆ·æ–°å†å²ä¸Šä¸‹æ–‡çŠ¶æ€
        setInterval(loadEmailStatus, 10000);  // 10ç§’åˆ·æ–° Email çŠ¶æ€
        setInterval(loadTelegramStatus, 10000);  // 10ç§’åˆ·æ–° Telegram çŠ¶æ€
    </script>
</body>
</html>